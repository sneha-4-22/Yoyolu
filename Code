flowchart LR
  %% Top inputs
  A1[GLOBAL FUND CHANGE] --> B[FUND CHANGE TRANSACTION]
  A2[PRODUCT FUND CHANGE] --> B
  A3[GATEWAY] --> B
  A4[FCO] --> C[PLAN FUND CHANGE] --> B
  A5[UPLOAD] --> C

  B --> START([START])

  %% initial checks
  START --> V{IS transaction valid?}
  V -- |no| --> FollowCurrent([follow current process]) --> END([END])
  V -- |yes| --> PDF{was pdf created?}

  PDF -- |no| --> CreateNotice[create and save notice] --> CWP[(CWP/DOCS DATABASE)] --> AddChanges[Additional changes FOR APM IF ANY] --> PDF
  PDF -- |yes| --> CheckPES{CHECK pes For apm service}

  %% ===== corrected central section =====
  %% CheckPES goes to PES DB -> Send -> VENDOR OR ADPM decision
  CheckPES -- |no| --> PES[(PES)]
  PES --> Send[Send data to APM Service] --> VendorDecision{VENDOR OR ADPM?}
  CheckPES -- |yes| --> VendorDecision

  %% VendorDecision routes:
  VendorDecision -- |yes| --> FollowExisting([follow existing APM process]) --> END
  VendorDecision -- |no| --> Send
  VendorDecision --> EmailGen{WAS FA / PA EMAIL GENERATED?}

  %% Email generation branch
  EmailGen -- |no| --> NewEmail[New Email template] --> TemplateVendor[template based on vendor] --> SubmitCheck{was fa., pa email SUBMIT?}
  EmailGen -- |yes| --> SubmitCheck

  %% Final submission branch
  SubmitCheck -- |yes| --> FMDB[(FUND MANAGER DFA DATABASE)] --> PlanReports[PLAN REPORTS] --> END
  SubmitCheck -- |no| --> END

  %% ========== STYLING ========== 
  classDef startend fill:#1f77b4,stroke:#0d3b66,stroke-width:2px,color:#fff;
  classDef decision fill:#ffcc00,stroke:#b38600,stroke-width:2px,color:#000;
  classDef process fill:#87cefa,stroke:#4682b4,stroke-width:1px,color:#000;
  classDef database fill:#90ee90,stroke:#006400,stroke-width:2px,color:#000;

  class START,END startend
  class V,PDF,CheckPES,VendorDecision,EmailGen,SubmitCheck decision
  class A1,A2,A3,A4,A5,B,C,FollowCurrent,CreateNotice,AddChanges,Send,FollowExisting,NewEmail,TemplateVendor,PlanReports process
  class CWP,PES,FMDB database
